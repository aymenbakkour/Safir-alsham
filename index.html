<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>سفير الشام</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<style>
body{background:#f4f4f4;font-family:"Tahoma";}
.section-box{background:white;padding:15px;border-radius:10px;margin-bottom:20px;}
.category-header{background:#e9ecef;padding:10px;border-radius:6px;cursor:pointer;font-weight:bold;}
.product-row{padding:8px;border-bottom:1px solid #eee;display:flex;align-items:center;}
.product-name{flex:2;font-weight:500;}
.product-price{width:80px;text-align:center;}
.product-actions{width:60px;text-align:center;display:flex;justify-content:center;}
.action-btn{width:32px;height:32px;border-radius:50%;border:none;color:white;font-size:18px;display:flex;align-items:center;justify-content:center;cursor:pointer;}
.add-btn{background:#0d6efd;}

.offer-item{display:flex;justify-content:space-between;align-items:center;padding:8px;border-bottom:1px solid #ddd;}
.offer-item button{
    width:28px;
    height:28px;
    font-size:16px;
    padding:0;
    border-radius:50%;
}
.preview-box{border:2px solid #0d6efd;padding:20px;border-radius:12px;background:white;text-align:center;}

.form-control{width:100%;padding:10px;margin-top:8px;border-radius:6px;border:1px solid #ccc;box-sizing:border-box;font-size:16px;}
.btn{width:100%;padding:12px;background:#1d4e89;color:white;border:none;border-radius:6px;margin-top:12px;font-size:17px;cursor:pointer;}
</style>
</head>
<body class="container py-3">

<h2 class="text-center mb-4">سفير الشام – إدارة المنتجات والعروض</h2>

<!-- نموذج إضافة منتج -->
<div class="section-box">
<h4>إضافة منتج جديد</h4>
<div class="row g-2">
<div class="col-6">
    <input id="pName" class="form-control" placeholder="اسم المنتج">
</div>
<div class="col-6">
    <select id="pCat" class="form-control">
        <option value="مواد غذائية">مواد غذائية</option>
        <option value="هدايا">هدايا</option>
        <option value="خدمة">خدمة</option>
        <option value="رصيد موبايل">رصيد موبايل</option>
    </select>
</div>
<div class="col-6">
    <input id="pPrice" class="form-control" type="number" placeholder="السعر (€)">
</div>
<div class="col-6">
    <button class="btn" onclick="addProduct()">إضافة المنتج</button>
</div>
</div>
</div>

<!-- جدول المنتجات -->
<div class="section-box">
<h4>المنتجات</h4>
<div id="productsArea"></div>
</div>

<!-- إنشاء العرض -->
<div class="section-box">
<h4>إنشاء عرض</h4>

<div id="offerItems"></div>

<div class="row g-2 mt-3">
<div class="col-4">
    <input id="delivery" type="number" class="form-control" placeholder="تكلفة التوصيل (€)" oninput="updateTotal()">
</div>
<div class="col-4">
    <input id="transfer" type="number" class="form-control" placeholder="تكلفة التحويل (€)" oninput="updateTotal()">
</div>
<div class="col-4">
    <input id="extraText" class="form-control" placeholder="جملة اختيارية تحت العنوان">
</div>
</div>

<h5 class="mt-3">المجموع النهائي: <span id="total">0</span> €</h5>

<button class="btn btn-success w-100 mt-2" onclick="showPreview()">معاينة العرض</button>
</div>

<!-- المعاينة -->
<div class="section-box">
<h4>معاينة العرض</h4>
<div id="preview" class="preview-box"></div>
<button class="btn w-100 mt-3" onclick="downloadImage()">تصدير كصورة</button>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script>
let products = [];
let offer = [];

function addProduct(){
    let name = pName.value.trim();
    let cat = pCat.value;
    let price = parseFloat(pPrice.value);
    if(!name || isNaN(price)){ alert("أكمل الحقول"); return; }
    products.push({name,cat,price});
    pName.value = ""; pPrice.value = "";
    renderProducts();
}

function renderProducts(){
    let area = document.getElementById("productsArea");
    area.innerHTML = "";
    let cats = [...new Set(products.map(p=>p.cat))];
    cats.forEach(cat=>{
        let box = document.createElement("div");
        box.innerHTML += `<div class="category-header" onclick="toggleCat(this)">${cat}</div>`;
        let group = document.createElement("div"); group.style.display="block";
        products.filter(p=>p.cat===cat).forEach((p,i)=>{
            let idx = products.indexOf(p);
            group.innerHTML += `
            <div class="product-row">
                <div class="product-name">${p.name}</div>
                <div class="product-price">${p.price} €</div>
                <div class="product-actions">
                    <button class="action-btn add-btn" title="إضافة للعرض" onclick="addToOffer(${idx})">+</button>
                </div>
            </div>`;
        });
        box.appendChild(group); area.appendChild(box);
    });
}

function toggleCat(h){ let next=h.nextElementSibling; next.style.display=next.style.display==="none"?"block":"none"; }
function addToOffer(i){ offer.push(products[i]); renderOffer(); updateTotal(); }
function removeOffer(i){ offer.splice(i,1); renderOffer(); updateTotal(); }

function renderOffer(){
    let area = document.getElementById("offerItems"); area.innerHTML="";
    offer.forEach((p,i)=>{
        area.innerHTML += `<div class="offer-item">
            <span>${p.name}</span>
            <span>${p.price} €</span>
            <button class="btn btn-sm btn-danger" onclick="removeOffer(${i})">×</button>
        </div>`;
    });
}

function updateTotal(){
    let sum = offer.reduce((a,b)=>a+b.price,0);
    sum += parseFloat(delivery.value||0); sum += parseFloat(transfer.value||0);
    total.innerHTML = sum.toFixed(2);
}

function showPreview(){
    let html = `<h2 style="color:#0d6efd;font-weight:bold;">سفير الشام</h2>
    <h4>عرض اليوم</h4>
    <p>${extraText.value}</p>
    <hr>
    ${offer.map(p=>`<div>${p.name} — ${p.price} €</div>`).join("")}
    <hr><h3>المجموع: ${total.innerHTML} €</h3>`;
    preview.innerHTML = html;
}

function downloadImage(){
    html2canvas(document.getElementById("preview")).then(canvas=>{
        let a=document.createElement("a"); a.download="offer.png"; a.href=canvas.toDataURL(); a.click();
    });
}
</script>
</body>
</html>